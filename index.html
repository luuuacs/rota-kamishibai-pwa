<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="manifest" href="manifest.json">

<script>
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('service-worker.js');
}
</script>

<title>Rota Kamishibai</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://unpkg.com/heic2any/dist/heic2any.min.js"></script>

<style>
* { box-sizing: border-box; }
body { font-family: Arial, sans-serif; background: #f4f4f4; margin: 0; padding: 15px; }
h2 { margin-top: 0; text-align: center; }
.section { background: white; padding: 15px; margin-bottom: 15px; border-radius: 8px; border: 1px solid #ddd; }
button { padding: 10px; margin: 5px 3px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }

.btn-group { display: flex; justify-content: space-between; }
.btn-group button { flex: 1; background: #eee; color: #333; border: 1px solid #ccc; }

/* Cores de Status - Agora corrigidas */
.status-ok { background-color: #3ec303 !important; color: white !important; }
.status-nok { background-color: #DC2828 !important; color: white !important; }
.status-att { background-color: #f4bb31 !important; color: white !important; }
.active-turma { outline: 3px solid black; background: #333 !important; color: white !important; }

input, textarea, select { width: 100%; padding: 10px; margin-top: 5px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 16px; }
.add-btn { width: 100%; background: #444; color: white; }
.finish-btn { width: 100%; background: #000; color: white; font-size: 18px; margin-top: 20px; }
.remove-btn { background: #ffeded; color: red; width: 100%; font-size: 12px; margin-top: 10px; }
</style>
</head>

<body>

<h2>ROTA KAMISHIBAI</h2>

<div class="section">
  <label>Data</label>
  <input type="date" id="data">

  <label>Turma</label>
  <div class="btn-group" id="turmaBtns">
    <button onclick="selectTurma(this,'A')">A</button>
    <button onclick="selectTurma(this,'B')">B</button>
    <button onclick="selectTurma(this,'C')">C</button>
    <button onclick="selectTurma(this,'D')">D</button>
  </div>
</div>

<div id="itens"></div>

<button class="add-btn" onclick="addItem()">+ Adicionar item</button>
<br>
<button class="finish-btn" onclick="gerarPDF()">Finalizar e abrir PDF</button>

<script>
let turmaSelecionada = "";
let itens = [];

function selectTurma(btn, valor) {
  document.querySelectorAll('#turmaBtns button').forEach(b => b.classList.remove('active-turma'));
  btn.classList.add('active-turma');
  turmaSelecionada = valor;
}

function addItem() {
  const id = Date.now();
  const setores = ["Rota do Líder","Setor 01","Setor 02","Setor 03","Setor 04","Setor 05"];
  const setorOptions = setores.map(s => `<option value="${s}">${s}</option>`).join('');

  const html = `
    <div class="section" id="item-${id}">
      <select onchange="updateItem(${id}, 'setor', this.value)">
        <option value="">Selecione o Setor</option>
        ${setorOptions}
      </select>
      <input type="text" placeholder="Título" onchange="updateItem(${id}, 'titulo', this.value)">
      <input type="file" accept="image/*" onchange="handleImg(${id}, this)">
      <input type="text" placeholder="Responsável" onchange="updateItem(${id}, 'responsavel', this.value)">
      
      <div class="btn-group">
        <button onclick="setStatus(${id}, 'OK', this)">OK</button>
        <button onclick="setStatus(${id}, 'N/OK', this)">N/OK</button>
        <button onclick="setStatus(${id}, 'ATT', this)">ATT</button>
      </div>
      <textarea placeholder="Observações" onchange="updateItem(${id}, 'obs', this.value)"></textarea>
      <button class="remove-btn" onclick="removeItem(${id})">Remover item</button>
    </div>
  `;
  document.getElementById('itens').insertAdjacentHTML('beforeend', html);
  itens.push({ id, setor: '', titulo: '', img: '', responsavel: '', status: '', obs: '' });
}

function removeItem(id) {
  document.getElementById(`item-${id}`).remove();
  itens = itens.filter(i => i.id !== id);
}

function updateItem(id, campo, valor) {
  const item = itens.find(i => i.id === id);
  if (item) item[campo] = valor;
}

function setStatus(id, status, btn) {
  const item = itens.find(i => i.id === id);
  if (item) item.status = status;
  
  const botoes = btn.parentElement.querySelectorAll('button');
  botoes.forEach(b => b.classList.remove('status-ok', 'status-nok', 'status-att'));

  if (status === 'OK') btn.classList.add('status-ok');
  else if (status === 'N/OK') btn.classList.add('status-nok');
  else if (status === 'ATT') btn.classList.add('status-att');
}

function handleImg(id, input) {
  const file = input.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = (e) => updateItem(id, 'img', e.target.result);
  reader.readAsDataURL(file);
}

function drawHeader(pdf, data, turma) {
  pdf.setFontSize(18);
  pdf.setFont("helvetica", "bold");
  pdf.text("ROTA KAMISHIBAI", 10, 12);
  pdf.setFontSize(10);
  pdf.text(`Data: ${data} | Turma: ${turma}`, 140, 12);
  pdf.line(10, 15, 200, 15);
}

async function gerarPDF() {
  const data = document.getElementById("data").value;
  if (!data || !turmaSelecionada || itens.length === 0) {
    alert("Preencha data, turma e adicione itens.");
    return;
  }

  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF("p","mm","a4");
  const ordemSetores = ["Rota do Líder","Setor 01","Setor 02","Setor 03","Setor 04","Setor 05"];
  let first = true;

  for (let setor of ordemSetores) {
    for (let item of itens.filter(i=>i.setor===setor)) {
      if (!item.titulo || !item.img || !item.status) continue;
      if (!first) pdf.addPage();
      first = false;

      drawHeader(pdf, data, turmaSelecionada);
      pdf.setFontSize(14);
      pdf.text(`${setor} - ${item.titulo}`, 10, 25);
      pdf.addImage(item.img, "JPEG", 10, 30, 190, 100);
      pdf.setFontSize(12);
      pdf.text(`Responsável: ${item.responsavel}`, 10, 140);

      let cor = item.status==="OK" ? [62,195,3] : item.status==="N/OK" ? [220,40,40] : [244,187,49];
      pdf.setFillColor(...cor);
      pdf.rect(10, 150, 40, 10, "F");
      pdf.setTextColor(255,255,255);
      pdf.text(item.status, 15, 157);

      pdf.setTextColor(0,0,0);
      if (item.obs) {
        pdf.text("Observações:", 10, 170);
        pdf.text(item.obs, 10, 178, {maxWidth: 190});
      }
    }
  }

  const pdfBlob = pdf.output("blob");
  const fileName = `ROTA_${turmaSelecionada}_${data}.pdf`;
  const file = new File([pdfBlob], fileName, { type: "application/pdf" });

  if (navigator.canShare && navigator.canShare({ files: [file] })) {
    try {
      await navigator.share({ files: [file], title: 'Rota Kamishibai' });
    } catch (err) { pdf.save(fileName); }
  } else {
    pdf.save(fileName);
  }
}
</script>
</body>
</html>
