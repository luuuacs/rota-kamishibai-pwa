<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rota Kamishibai - Colaborativo</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#444444">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://unpkg.com/heic2any/dist/heic2any.min.js"></script>

    <style>
        :root {
            --bg-color: #f4f4f4;
            --card-bg: #ffffff;
            --border-color: #dddddd;
            --text-dark: #333333;
            --primary: #444444;
            --secondary: #000000;
            --status-ok: #3ec303;
            --status-nok: #DC2828;
            --status-att: #f4bb31;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg-color); margin: 0; padding: 15px; color: var(--text-dark); }
        
        /* Utilit√°rios de Visibilidade */
        .view { display: none; animation: fadeIn 0.3s; }
        .view.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* Cabe√ßalho Fixo */
        .header-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .header-bar h2 { margin: 0; font-size: 1.2rem; }

        .section { background: var(--card-bg); padding: 15px; margin-bottom: 15px; border-radius: 8px; border: 1px solid var(--border-color); box-shadow: 0 2px 4px rgba(0,0,0,0.05); position: relative; }
        
        /* Lista de Relat√≥rios */
        .report-card { 
            width: 100%; text-align: left; padding: 20px; margin-bottom: 10px; 
            background: white; border: 1px solid #ddd; border-radius: 8px; cursor: pointer; 
            position: relative; 
        }
        .report-card:hover { border-color: var(--primary); }
        .report-card h3 { margin: 0 0 5px 0; font-size: 1rem; }
        .report-card span { font-size: 0.8rem; color: #666; }

        /* Bot√£o de Lixeira (Admin) */
        .trash-btn {
            position: absolute; right: 15px; top: 20px;
            background: #ffebeb; color: red; border: 1px solid red;
            border-radius: 4px; padding: 5px 10px; z-index: 10;
        }

        /* Estilos de Form */
        label { display: block; margin-bottom: 5px; font-weight: bold; font-size: 14px; }
        input, textarea, select { width: 100%; padding: 12px; margin-bottom: 12px; border: 1px solid var(--border-color); border-radius: 6px; font-size: 16px; outline: none; }
        button { padding: 12px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; }
        .btn-primary { background: var(--primary); color: white; width: 100%; }
        .btn-add { background: var(--primary); color: white; width: 100%; margin: 10px 0; }
        .btn-finish { background: var(--secondary); color: white; width: 100%; margin-top: 20px; }
        .remove-btn { background: #ffeded; color: #d32f2f; width: 100%; font-size: 12px; margin-top: 5px; }

        .btn-group { display: flex; gap: 8px; margin-bottom: 10px; }
        .btn-group button { flex: 1; background: #eee; font-size: 0.8rem; }
        .active-turma { background: var(--secondary) !important; color: white !important; }
        .status-ok { background: var(--status-ok) !important; color: white !important; }
        .status-nok { background: var(--status-nok) !important; color: white !important; }
        .status-att { background: var(--status-att) !important; color: white !important; }
        
        .owner-tag { position: absolute; top: 10px; right: 10px; font-size: 10px; color: #999; }
        .loading-msg { font-size: 12px; color: #666; display: none; text-align: center; }
    </style>
</head>
<body>

    <div id="view-login" class="view active">
        <h2>Acesso Rota Kamishibai</h2>
        <div class="section">
            <label>Nome Completo</label>
            <input type="text" id="login-nome" placeholder="Seu nome">
            <label>Matr√≠cula</label>
            <input type="number" id="login-mat" placeholder="Sua matr√≠cula">
            <label>Senha do Sistema</label>
            <input type="password" id="login-senha" placeholder="Senha √∫nica">
            <button class="btn-primary" onclick="App.realizarLogin()">Entrar</button>
        </div>
    </div>

    <div id="view-list" class="view">
        <div class="header-bar">
            <h2>Relat√≥rios Ativos</h2>
            <button onclick="App.criarNovoRelatorio()" style="background:var(--status-ok); color:white; padding:8px 15px">+ Novo</button>
        </div>
        <div id="lista-relatorios"></div>
    </div>

    <div id="view-report" class="view">
        <div class="header-bar">
            <button onclick="UI.mostrarTela('view-list')" style="background:none; border:1px solid #ccc">‚Üê Voltar</button>
            <h2 id="report-title">Relat√≥rio</h2>
        </div>

        <div class="section">
            <label>Turma</label>
            <div class="btn-group" id="turmaBtns">
                <button type="button" onclick="App.updateReportMeta('turma', 'A')" id="btn-turma-A">A</button>
                <button type="button" onclick="App.updateReportMeta('turma', 'B')" id="btn-turma-B">B</button>
                <button type="button" onclick="App.updateReportMeta('turma', 'C')" id="btn-turma-C">C</button>
                <button type="button" onclick="App.updateReportMeta('turma', 'D')" id="btn-turma-D">D</button>
            </div>
        </div>

        <div id="itensContainer"></div>
        <button class="btn-add" onclick="App.addItem()">+ Adicionar meu item</button>
        <button class="btn-finish" onclick="App.gerarPDF()">Gerar PDF Coletivo</button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, push, onValue, update, remove, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCokchI_cds7eKr5WuhZ5-ZyLn1Mgllk-U",
            authDomain: "rota-kamishibai-6fd6d.firebaseapp.com",
            databaseURL: "https://rota-kamishibai-6fd6d-default-rtdb.firebaseio.com",
            projectId: "rota-kamishibai-6fd6d",
            storageBucket: "rota-kamishibai-6fd6d.firebasestorage.app",
            messagingSenderId: "780267766425",
            appId: "1:780267766425:web:7815e063da1dbd7f4f2e08",
            measurementId: "G-B4M5RMG2MK"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // --- CORE LOGIC ---
        window.App = {
            user: JSON.parse(localStorage.getItem('rota_user')) || null,
            currentReportId: null,
            setores: ["Rota do L√≠der", "Setor 01", "Setor 02", "Setor 03", "Setor 04", "Setor 05"],

            async realizarLogin() {
                const nome = document.getElementById('login-nome').value;
                const mat = document.getElementById('login-mat').value;
                const senha = document.getElementById('login-senha').value;

                if(!nome || !mat || !senha) return alert("Preencha todos os campos");

                const snap = await get(ref(db, 'config/acesso_senha'));
                if(senha === String(snap.val())) {
                    this.user = { nome, mat };
                    localStorage.setItem('rota_user', JSON.stringify(this.user));
                    UI.mostrarTela('view-list');
                    this.escutarRelatorios();
                } else {
                    alert("Senha incorreta!");
                }
            },

            escutarRelatorios() {
                onValue(ref(db, 'relatorios'), (snapshot) => {
                    const data = snapshot.val();
                    const container = document.getElementById('lista-relatorios');
                    container.innerHTML = "";
                    const agora = Date.now();
                    const isAdmin = this.user && String(this.user.mat) === "81034524";

                    for (let id in data) {
                        if (agora - data[id].timestamp < 86400000) {
                            const btnDelete = isAdmin ? 
                                `<button class="trash-btn" onclick="event.stopPropagation(); App.deletarRelatorio('${id}')">üóëÔ∏è</button>` : '';

                            container.innerHTML += `
                                <div class="report-card" onclick="App.abrirRelatorio('${id}')">
                                    <h3>Rota Turma ${data[id].turma || '?'}</h3>
                                    <span>Criado em: ${data[id].data}</span>
                                    ${btnDelete}
                                </div>`;
                        }
                    }
                });
            },

            deletarRelatorio(id) {
                if(confirm("ATEN√á√ÉO: Deseja apagar este relat√≥rio e todos os itens dele?")) {
                    remove(ref(db, `relatorios/${id}`));
                }
            },

            criarNovoRelatorio() {
                const novoRef = push(ref(db, 'relatorios'));
                const dataStr = new Date().toLocaleDateString('pt-BR');
                set(novoRef, {
                    data: dataStr,
                    timestamp: Date.now(),
                    turma: '',
                    itens: {}
                });
                this.abrirRelatorio(novoRef.key);
            },

            abrirRelatorio(id) {
                this.currentReportId = id;
                UI.mostrarTela('view-report');
                
                onValue(ref(db, `relatorios/${id}`), (snapshot) => {
                    const report = snapshot.val();
                    if(!report) {
                        UI.mostrarTela('view-list');
                        return;
                    } 
                    
                    document.getElementById('report-title').innerText = `Rota Turma ${report.turma || '?'}`;
                    UI.updateTurmaButtons(report.turma);
                    UI.renderItens(report.itens || {});
                });
            },

            updateReportMeta(campo, valor) {
                update(ref(db, `relatorios/${this.currentReportId}`), { [campo]: valor });
            },

            addItem() {
                const itemRef = push(ref(db, `relatorios/${this.currentReportId}/itens`));
                set(itemRef, {
                    id: itemRef.key,
                    owner: this.user.mat,
                    responsavel: this.user.nome,
                    setor: '',
                    titulo: '',
                    status: '',
                    img: '',
                    obs: ''
                });
            },

            deleteItem(itemId) {
                if(confirm('Tem certeza que deseja apagar este item?')) {
                    remove(ref(db, `relatorios/${this.currentReportId}/itens/${itemId}`));
                }
            },

            updateItem(itemId, campo, valor) {
                update(ref(db, `relatorios/${this.currentReportId}/itens/${itemId}`), { [campo]: valor });
            },

            async handleImg(itemId, input) {
                const file = input.files[0];
                if (!file) return;
                const loader = document.getElementById(`loading-${itemId}`);
                loader.style.display = "block";
                loader.innerText = "‚è≥ Processando...";

                try {
                let blob = file;
                if (file.name.toLowerCase().endsWith(".heic")) {
                    blob = await heic2any({ blob, toType: "image/jpeg", quality: 0.6 });
                }
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const maxW = 800; 
                        const scale = maxW / img.width;
                        canvas.width = maxW;
                        canvas.height = img.height * scale;
                        canvas.getContext('2d').drawImage(img, 0, 0, canvas.width, canvas.height);
                        
                        const base64 = canvas.toDataURL('image/jpeg', 0.7);
                        App.updateItem(itemId, 'img', base64);
                        loader.innerHTML = "<b style='color:green'>‚úÖ Foto salva!</b>";
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(blob);
                } catch (e) { 
                    alert("Erro na imagem"); 
                    loader.style.display="none"; 
                }
            },

            async gerarPDF() {
                const snap = await get(ref(db, `relatorios/${this.currentReportId}`));
                const report = snap.val();
                if(!report.itens) return alert("Nenhum item para gerar PDF");

                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF("p", "mm", "a4");
                let first = true;

                // --- ORDENA√á√ÉO PARA O PDF (Mant√©m por Setor) ---
                const sortedItens = Object.values(report.itens).sort((a,b) => {
                    const idxA = App.setores.indexOf(a.setor) === -1 ? 999 : App.setores.indexOf(a.setor);
                    const idxB = App.setores.indexOf(b.setor) === -1 ? 999 : App.setores.indexOf(b.setor);
                    return idxA - idxB;
                });

                for (const item of sortedItens) {
                    if (!item.img) continue;
                    if (!first) pdf.addPage();
                    first = false;

                    pdf.setFontSize(16); pdf.text("ROTA KAMISHIBAI", 10, 15);
                    pdf.setFontSize(10); pdf.text(`Data: ${report.data} | Turma: ${report.turma}`, 140, 15);
                    pdf.line(10, 18, 200, 18);
                    
                    pdf.setFontSize(14); pdf.text(`${item.setor || 'Setor n√£o informado'} - ${item.titulo}`, 10, 28);
                    
                    // --- CORRE√á√ÉO DE IMAGEM NO PDF ---
                    const imgProps = pdf.getImageProperties(item.img);
                    const pdfPageWidth = 210;
                    const maxW = 190;
                    const maxH = 110; 
                    
                    const ratio = imgProps.width / imgProps.height;
                    let renderW, renderH;

                    if (maxW / ratio <= maxH) {
                        renderW = maxW;
                        renderH = maxW / ratio;
                    } else {
                        renderH = maxH;
                        renderW = maxH * ratio;
                    }

                    const x = (pdfPageWidth - renderW) / 2;
                    pdf.addImage(item.img, "JPEG", x, 35, renderW, renderH);
                    
                    pdf.text(`Respons√°vel: ${item.responsavel}`, 10, 155);
                    
                    const cor = item.status === "OK" ? [62, 195, 3] : [220, 40, 40];
                    pdf.setFillColor(...cor); pdf.rect(10, 160, 30, 8, "F");
                    pdf.setTextColor(255); pdf.text(item.status || "S/S", 15, 166);
                    pdf.setTextColor(0);
                    if(item.obs) pdf.text(`Obs: ${item.obs}`, 10, 175, {maxWidth: 180});
                }
                pdf.save(`Rota_${report.turma}_${report.data}.pdf`);
            }
        };

        window.UI = {
            mostrarTela(id) {
                document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
                document.getElementById(id).classList.add('active');
            },

            updateTurmaButtons(turma) {
                document.querySelectorAll('#turmaBtns button').forEach(b => {
                    b.classList.toggle('active-turma', b.innerText === turma);
                });
            },

            renderItens(itens) {
                const container = document.getElementById('itensContainer');
                container.innerHTML = "";
    
                // --- ORDENA√á√ÉO NA TELA DE EDI√á√ÉO (Apenas cronol√≥gica) ---
                // Isso impede que os itens mudem de lugar ao selecionar o setor
                const itensArray = Object.values(itens).sort((a,b) => {
                    return a.id.localeCompare(b.id);
                });

                itensArray.forEach(item => {
                    const id = item.id;
                    const isOwner = String(item.owner) === String(App.user.mat);
                    const disabled = !isOwner ? 'disabled' : '';
                    const temFoto = !!item.img; 

                    container.innerHTML += `
                        <div class="section">
                            <span class="owner-tag">Resp: ${item.responsavel}</span>
                            <select ${disabled} onchange="App.updateItem('${id}', 'setor', this.value)">
                                <option value="">Selecione o Setor...</option>
                                ${App.setores.map(s => `<option value="${s}" ${item.setor===s?'selected':''}>${s}</option>`).join('')}
                            </select>
                            <input type="text" placeholder="T√≠tulo" value="${item.titulo}" ${disabled} onchange="App.updateItem('${id}', 'titulo', this.value)">
                            
                            <div style="margin: 10px 0; padding: 12px; border: 1px solid #eee; border-radius: 8px; background: ${temFoto ? '#f0fff0' : '#fafafa'}">
                                <label style="font-size:13px">${temFoto ? '‚úÖ Foto no Sistema' : 'üì∑ Adicionar Foto'}</label>
                                
                                ${temFoto ? `
                                    <div style="margin-top:8px; display:flex; align-items:center; gap:10px">
                                        <img src="${item.img}" style="width:50px; height:50px; object-fit:cover; border-radius:4px; border:1px solid #ddd">
                                        ${isOwner ? `<button onclick="document.getElementById('file-${id}').click()" style="font-size:11px; padding:5px; background:#fff; border:1px solid #ccc; border-radius:4px">Trocar Foto</button>` : ''}
                                    </div>
                                ` : ''}

                                ${isOwner ? `
                                    <input type="file" id="file-${id}" accept="image/*" 
                                           style="${temFoto ? 'display:none' : 'display:block'}; margin-top:8px"
                                           onchange="App.handleImg('${id}', this)">
                                ` : ''}
                                <div id="loading-${id}" class="loading-msg"></div>
                            </div>

                            <div class="btn-group">
                                <button class="${item.status==='OK'?'status-ok':''}" ${disabled} onclick="App.updateItem('${id}', 'status', 'OK')">OK</button>
                                <button class="${item.status==='N/OK'?'status-nok':''}" ${disabled} onclick="App.updateItem('${id}', 'status', 'N/OK')">N/OK</button>
                            </div>
                            <textarea placeholder="Obs" ${disabled} onchange="App.updateItem('${id}', 'obs', this.value)">${item.obs || ''}</textarea>
                            
                            ${isOwner ? `<button class="remove-btn" onclick="App.deleteItem('${id}')">Remover Item</button>` : ''}
                        </div>`;
                });
            }
        };

        if(App.user) { 
            UI.mostrarTela('view-list'); 
            App.escutarRelatorios(); 
        }
    </script>
</body>
</html>
