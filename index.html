<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="manifest" href="manifest.json">

<script>
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('service-worker.js');
}
</script>

<title>Rota Kamishibai</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://unpkg.com/heic2any/dist/heic2any.min.js"></script>

<style>
* { box-sizing: border-box; }
body { font-family: Arial, sans-serif; background: #f4f4f4; margin: 0; padding: 15px; }
h2 { margin-top: 0; text-align: center; color: #333; }
.section { background: white; padding: 15px; margin-bottom: 15px; border-radius: 8px; border: 1px solid #ddd; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
button { padding: 12px; margin: 5px 3px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }
.btn-group { display: flex; justify-content: space-between; margin-top: 5px; }
.btn-group button { flex: 1; background: #eee; color: #333; border: 1px solid #ccc; }
.btn-group button.active { background: #333 !important; color: white !important; outline: none; }
.status-ok { background: #3ec303 !important; color: white; }
.status-nok { background: #DC2828 !important; color: white; }
.status-att { background: #f4bb31 !important; color: white; }
input, textarea, select { width: 100%; padding: 12px; margin-top: 8px; margin-bottom: 12px; border: 1px solid #ccc; border-radius: 4px; font-size: 16px; }
label { font-weight: bold; font-size: 14px; color: #555; }
.add-btn { width: 100%; background: #444; color: white; margin-top: 10px; font-size: 16px; }
.finish-btn { width: 100%; background: #000; color: white; font-size: 18px; margin-top: 20px; padding: 15px; }
.remove-btn { background: #ffeded; color: #cc0000; border: 1px solid #ffcccc; width: 100%; margin-top: 10px; }
</style>
</head>

<body>

<h2>ROTA KAMISHIBAI</h2>

<div class="section">
  <label>Data da Inspeção</label>
  <input type="date" id="data">

  <label>Selecione a Turma</label>
  <div class="btn-group" id="turmaBtns">
    <button onclick="selectTurma(this,'A')">A</button>
    <button onclick="selectTurma(this,'B')">B</button>
    <button onclick="selectTurma(this,'C')">C</button>
    <button onclick="selectTurma(this,'D')">D</button>
  </div>
</div>

<div id="itens"></div>

<button class="add-btn" onclick="addItem()">+ Adicionar Novo Item</button>
<br>
<button class="finish-btn" onclick="gerarPDF()">Finalizar e Abrir PDF</button>

<script>
let turmaSelecionada = "";
let itens = [];

function selectTurma(btn, valor) {
  document.querySelectorAll('#turmaBtns button').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  turmaSelecionada = valor;
}

function addItem() {
  const id = Date.now();
  const setores = ["Rota do Líder","Setor 01","Setor 02","Setor 03","Setor 04","Setor 05"];
  const setorOptions = setores.map(s => `<option value="${s}">${s}</option>`).join('');

  const html = `
    <div class="section" id="item-${id}">
      <label>Setor</label>
      <select onchange="updateItem(${id}, 'setor', this.value)">
        <option value="">Selecione o Setor...</option>
        ${setorOptions}
      </select>
      
      <label>Título / Ponto de Verificação</label>
      <input type="text" placeholder="Ex: Organização de ferramentas" onchange="updateItem(${id}, 'titulo', this.value)">
      
      <label>Capturar Foto</label>
      <input type="file" accept="image/*" onchange="handleImg(${id}, this)">
      
      <label>Responsável</label>
      <input type="text" placeholder="Nome do responsável" onchange="updateItem(${id}, 'responsavel', this.value)">
      
      <label>Status da Verificação</label>
      <div class="btn-group" id="status-group-${id}">
        <button onclick="setStatus(${id}, 'OK', this)">OK</button>
        <button onclick="setStatus(${id}, 'N/OK', this)">N/OK</button>
        <button onclick="setStatus(${id}, 'ATT', this)">ATT</button>
      </div>
      
      <label style="display:block; margin-top:10px;">Observações</label>
      <textarea placeholder="Descreva detalhes se necessário..." onchange="updateItem(${id}, 'obs', this.value)"></textarea>
      
      <button class="remove-btn" onclick="removeItem(${id})">Excluir este item</button>
    </div>
  `;
  document.getElementById('itens').insertAdjacentHTML('beforeend', html);
  itens.push({ id, setor: '', titulo: '', img: '', responsavel: '', status: '', obs: '' });
}

function removeItem(id) {
  document.getElementById(`item-${id}`).remove();
  itens = itens.filter(i => i.id !== id);
}

function updateItem(id, campo, valor) {
  const item = itens.find(i => i.id === id);
  if (item) item[campo] = valor;
}

function setStatus(id, status, btn) {
  const item = itens.find(i => i.id === id);
  if (item) item.status = status;
  
  const parent = btn.parentElement;
  parent.querySelectorAll('button').forEach(b => b.className = '');
  btn.className = status === 'OK' ? 'status-ok active' : status === 'N/OK' ? 'status-nok active' : 'status-att active';
}

function handleImg(id, input) {
  const file = input.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = (e) => updateItem(id, 'img', e.target.result);
  reader.readAsDataURL(file);
}

function drawHeader(pdf, data, turma) {
  pdf.setFont("helvetica", "bold");
  pdf.setFontSize(18);
  pdf.text("ROTA KAMISHIBAI", 10, 15);
  pdf.setFontSize(10);
  pdf.setFont("helvetica", "normal");
  pdf.text(`Data: ${data} | Turma: ${turma}`, 145, 15);
  pdf.line(10, 18, 200, 18);
}

async function gerarPDF() {
  const dataInput = document.getElementById("data").value;
  if (!dataInput || !turmaSelecionada || itens.length === 0) {
    alert("Erro: Verifique se preencheu a DATA, a TURMA e se adicionou ITENS.");
    return;
  }

  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF("p","mm","a4");
  const ordemSetores = ["Rota do Líder","Setor 01","Setor 02","Setor 03","Setor 04","Setor 05"];
  let first = true;

  for (let setor of ordemSetores) {
    const itensDoSetor = itens.filter(i => i.setor === setor);
    for (let item of itensDoSetor) {
      if (!item.titulo || !item.img || !item.status) continue;

      if (!first) pdf.addPage();
      first = false;

      drawHeader(pdf, dataInput, turmaSelecionada);

      pdf.setFontSize(14);
      pdf.setFont("helvetica", "bold");
      pdf.text(`${setor} - ${item.titulo}`, 10, 28);
      
      try {
        pdf.addImage(item.img, "JPEG", 10, 35, 190, 100);
      } catch(e) { console.warn("Erro ao carregar imagem no PDF"); }

      pdf.setFontSize(12);
      pdf.text(`Responsável: ${item.responsavel || 'Não informado'}`, 10, 145);

      let cor = item.status==="OK" ? [62,195,3] : item.status==="N/OK" ? [220,40,40] : [244,187,49];
      pdf.setFillColor(...cor);
      pdf.rect(10, 150, 30, 8, "F");
      pdf.setTextColor(255, 255, 255);
      pdf.text(item.status, 15, 156);

      pdf.setTextColor(0,0,0);
      if (item.obs) {
        pdf.setFont("helvetica", "bold");
        pdf.text("Observações:", 10, 168);
        pdf.setFont("helvetica", "normal");
        pdf.setFontSize(10);
        pdf.text(item.obs, 10, 174, {maxWidth: 185});
      }
    }
  }

  // LÓGICA DE COMPARTILHAMENTO / ABRIR NO ANDROID
  const pdfBlob = pdf.output("blob");
  const nomeArquivo = `ROTA_${turmaSelecionada}_${dataInput}.pdf`;
  const arquivoParaCompartilhar = new File([pdfBlob], nomeArquivo, { type: "application/pdf" });

  if (navigator.canShare && navigator.canShare({ files: [arquivoParaCompartilhar] })) {
    try {
      await navigator.share({
        files: [arquivoParaCompartilhar],
        title: 'Relatório Rota Kamishibai',
        text: `Relatório de Inspeção - Turma ${turmaSelecionada}`,
      });
    } catch (err) {
      // Se o usuário cancelar o compartilhamento, o sistema tenta salvar o arquivo
      pdf.save(nomeArquivo);
    }
  } else {
    // Caso o navegador não suporte compartilhamento (browsers antigos ou PC)
    pdf.save(nomeArquivo);
  }
}
</script>

</body>
</html>
